name: Build and Deploy to Dev

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write   # Required for OIDC Token
  contents: read    # Required for checkout

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: ecs-fargate-cicd
  
  # Account IDs
  TOOLING_ACCOUNT_ID: "472294262990"
  DEV_ACCOUNT_ID: "067847734974"
  
  # Role ARNs
  TOOLING_ROLE_ARN: "arn:aws:iam::472294262990:role/ecs-fargate-cicd-github-actions-role"
  DEV_ROLE_ARN: "arn:aws:iam::067847734974:role/dev-ci-deploy-role"
  
  # ECR Configuration
  ECR_REPOSITORY: "ecs-fargate-cicd-inventory-api"

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Image Tag
        id: set-tag
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $IMAGE_TAG"

      - name: Configure AWS Credentials (Tooling)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.TOOLING_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag, and Push Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
        run: |
          cd app/inventory-api
          
          # Build the Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          
          # Push both tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

  deploy-dev:
    name: Deploy to Dev
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Tooling)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.TOOLING_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-DevDeploy

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: infrastructure/environments/dev
        run: terraform init

      - name: Terraform Plan
        working-directory: infrastructure/environments/dev
        run: |
          terraform plan -out=dev.tfplan \
            -var="image_tag=${{ needs.build.outputs.image_tag }}"

      - name: Terraform Apply
        working-directory: infrastructure/environments/dev
        run: terraform apply -auto-approve dev.tfplan

      - name: Get ALB DNS Name
        working-directory: infrastructure/environments/dev
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "Not yet available")
          echo "## ðŸš€ Dev Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ALB DNS:** http://$ALB_DNS" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
